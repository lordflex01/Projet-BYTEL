<?php

namespace App\Controller;

use App\Entity\CodeProjet;
use App\Form\CodeProjetType;
use App\Form\FileUploadType;
use App\Repository\CodeProjetRepository;
use App\Repository\TachesRepository;
use App\Service\CodeProjetService;
use App\Service\FileUploader;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\IsGranted;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

/**
 * @IsGranted("ROLE_ADMIN")
 * @Route("/code/projet")
 */
class CodeProjetController extends AbstractController
{
    /**
     * @IsGranted("ROLE_ADMIN")
     * @Route("/new", name="code_projet_new", methods={"GET","POST"})
     */
    public function new(Request $request): Response
    {
        $codeProjet = new CodeProjet();
        $gestionProjet = new GestionProjet();
        $form = $this->createForm(CodeProjetType::class, $codeProjet);
        $form->handleRequest($request);
        $codeProjet->setBudgetConsomme(0);
        $codeProjet->setChargeConsomme(0);

        $gestionProjet->setBudgetNRJConsomme(0);
        $gestionProjet->setChargeNRJConsomme(0);

        $gestionProjet->setBudgetDECOConsomme(0);
        $gestionProjet->setChargeDECOConsomme(0);

        $gestionProjet->setBudgetCLOEConsomme(0);
        $gestionProjet->setChargeCLOEConsomme(0);

        $gestionProjet->setBudgetTransverseConsomme(0);
        $gestionProjet->setChargeTransverseConsomme(0); 


        if ($form->isSubmitted() && $form->isValid()) {
            $entityManager = $this->getDoctrine()->getManager();
            $entityManager->persist($codeProjet);

            $gestionProjet->setCodeProjet($codeProjet);
            $entityManager->persist($gestionProjet);

            $entityManager->flush();
            return $this->redirectToRoute('code_projet_index');
        }

        return $this->render('code_projet/new.html.twig', [
            'code_projet' => $codeProjet,
            'form' => $form->createView(),
        ]);
    }
}
